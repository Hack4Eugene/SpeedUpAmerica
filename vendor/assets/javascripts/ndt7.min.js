!function(){"use strict";"undefined"==typeof WebSocket&&(global.WebSocket=require("isomorphic-ws")),"undefined"==typeof fetch&&(global.fetch=require("node-fetch")),"undefined"==typeof Worker&&(global.Worker=require("workerjs"));const e=function(){const e=function(e,r,t){return void 0!==r&&e in r?r[e]:void 0!==t?t:function(){}},r=function(e){throw new Error(e)};async function t(t,o){const a={error:e("error",o,r),serverDiscovery:e("serverDiscovery",o),serverChosen:e("serverChosen",o)};let n="wss";if(t&&"protocol"in t&&(n=t.protocol),t&&"server"in t)return{"///ndt/v7/download":n+"://"+t.server+"/ndt/v7/download","///ndt/v7/upload":n+"://"+t.server+"/ndt/v7/upload"};let s=t&&"loadbalancer"in t?t.loadbalancer.toString():"https://locate.measurementlab.net/v2/nearest/ndt/ndt7";s+="?client_name=ndt7-js",s+=t&&"geohash"in t?"&client_geohash="+t.geohash:"";const d=new URL(s);a.serverDiscovery({loadbalancer:d});const l=await fetch(d).catch(e=>{throw new Error(e)}),c=await l.json();if(!("results"in c))return a.error(`Could not understand response from ${d}: ${c}`),{};const i=c.results[0];return a.serverChosen(i),{"///ndt/v7/download":i.urls[n+":///ndt/v7/download"],"///ndt/v7/upload":i.urls[n+":///ndt/v7/upload"]}}const o=async function(e,r,t,o,a){if(!0!==e.userAcceptedDataPolicy&&!0!==e.mlabDataPolicyInapplicable)return r.error("The M-Lab data policy is applicable and the user has not explicitly accepted that data policy."),1;let n,s;"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node&&(o=__dirname+"/"+o);const d=new Worker(o),l=new Promise(e=>{d.resolve=function(t){0==t&&r.complete({LastClientMeasurement:n,LastServerMeasurement:s}),d.terminate(),e(t)}}),c=setTimeout(()=>d.resolve(0),1e4);d.onmessage=function(e){if(e.data&&e.data.MsgType&&"error"!==e.data.MsgType)"start"===e.data.MsgType?r.start(e.data.Data):"measurement"==e.data.MsgType?"server"==e.data.Source?(s=JSON.parse(e.data.ServerMessage),r.measurement({Source:e.data.Source,Data:s})):(n=e.data.ClientData,r.measurement({Source:e.data.Source,Data:e.data.ClientData})):"complete"==e.data.MsgType&&(clearTimeout(c),d.resolve(0));else{clearTimeout(c),d.resolve(1);const t=e.data?e.data.Error:a+" error";r.error(t)}};const i=await t.catch(e=>{throw clearTimeout(c),d.resolve(2),e});return d.postMessage(i),await l};async function a(t,a,n){const s={error:e("error",a,r),start:e("downloadStart",a),measurement:e("downloadMeasurement",a),complete:e("downloadComplete",a)},d=t.downloadworkerfile||"ndt7-download-worker.min.js";return await o(t,s,n,d,"download").catch(e=>{s.error(e)})}async function n(t,a,n){const s={error:e("error",a,r),start:e("uploadStart",a),measurement:e("uploadMeasurement",a),complete:e("uploadComplete",a)},d=t.uploadworkerfile||"ndt7-upload-worker.min.js";return await o(t,s,n,d,"upload").catch(e=>{s.error(e)})<<4}return{discoverServerURLs:t,downloadTest:a,uploadTest:n,test:async function(e,r){const o=t(e,r);return await a(e,r,o)+await n(e,r,o)}}}();"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:window.ndt7=e}();
